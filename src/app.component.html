<main class="min-h-screen flex flex-col font-sans">
  <!-- Header -->
  <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700/50 sticky top-0 z-20">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center space-x-3">
          <svg class="h-8 w-8 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12.75h16.5m-16.5 3.75h16.5M3.75 6.75h16.5m-16.5 9.75h16.5" /></svg>
          <div>
            <h1 class="text-xl font-bold text-gray-100 tracking-wider">Arquitecto de Portafolios Robustos</h1>
            @if (rawStrategies().length > 0) {
              <p class="text-xs text-gray-400">Test completado: {{ sortedStrategies().length }} de {{ rawStrategies().length }} estrategias</p>
            } @else if (uploadStatus(); as status) {
              <p class="text-xs" [class.text-green-400]="status.type === 'success'" [class.text-red-400]="status.type === 'error'">
                {{ status.message }}
              </p>
            }
          </div>
        </div>
      </div>
      <!-- Portfolio Chart Container -->
      <div class="relative h-40">
        @if (portfolio(); as p) {
          <div #portfolioChart class="w-full h-full absolute bottom-0"></div>
          <div class="absolute top-2 left-2 text-white font-semibold text-sm bg-gray-900/50 px-2 py-1 rounded">Beneficio del Portafolio</div>
        } @else {
          <div class="flex items-center justify-center h-full text-gray-500">
            <p>Seleccione estrategias para ver el gráfico del portafolio.</p>
          </div>
        }
      </div>
    </div>
  </header>

  <div class="flex-grow flex max-w-screen-2xl mx-auto w-full p-4 sm:p-6 lg:p-8 space-x-8">
    <!-- Left Sidebar: Upload & Portfolio -->
    <aside class="w-full max-w-xs xl:max-w-sm flex-shrink-0 space-y-8 self-start sticky top-60 sm:top-[15.5rem] lg:top-64">
      
      <!-- Upload Card -->
      <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700/50">
        <h2 class="text-lg font-semibold text-gray-100 mb-4">Cargar Estrategias</h2>
        <div class="space-y-3">
          <label for="strategy-upload" class="w-full inline-block text-center px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 cursor-pointer transition-colors">
            Seleccionar archivo JSON
          </label>
          <input id="strategy-upload" type="file" class="hidden" (change)="onFileSelected($event)" accept=".json" multiple>
        </div>
      </div>

      <!-- Portfolio Card -->
      <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700/50">
        <div class="flex items-center justify-between mb-6">
           <div class="flex items-center space-x-3">
             <svg class="h-6 w-6 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
              </svg>
              <h2 class="text-lg font-semibold text-gray-100">Arquitecto de Portafolios</h2>
           </div>
          <button (click)="reiniciarPortfolio()" class="text-sm text-cyan-400 hover:text-cyan-300 transition-colors">Reiniciar</button>
        </div>
        @if (selectedStrategies().length === 0) {
          <div class="text-center text-gray-500 py-8">
            <p>Seleccione estrategias de la tabla para construir un portafolio.</p>
          </div>
        } @else {
          <div class="space-y-4">
             <div class="flex justify-end">
                <button (click)="exportPortfolio()" 
                        [disabled]="selectedStrategies().length === 0"
                        class="px-3 py-1.5 bg-teal-600 text-white text-xs font-semibold rounded-md hover:bg-teal-700 transition-colors disabled:bg-teal-800 disabled:text-gray-400 disabled:cursor-not-allowed flex items-center space-x-2">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span>Exportar JSON</span>
                </button>
            </div>
             <!-- Walk-Forward Analysis Result -->
            @if (walkForwardAnalysis(); as wf) {
              <div class="p-3 rounded-lg border" 
                   [class.bg-green-900/40]="wf.status === 'robust'" 
                   [class.border-green-500/50]="wf.status === 'robust'"
                   [class.bg-red-900/40]="wf.status === 'fragile'"
                   [class.border-red-500/50]="wf.status === 'fragile'">
                <div class="flex items-center space-x-3">
                  @if (wf.status === 'robust') {
                    <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0">
                      <svg class="w-6 h-6 text-green-400 animate-pulse" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <div>
                      <h4 class="font-semibold text-green-300">Portafolio Robusto</h4>
                      <p class="text-xs text-gray-400">Las métricas se mantienen en el 20% de validación.</p>
                    </div>
                  } @else {
                    <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0">
                      <svg class="w-6 h-6 text-red-400 animate-pulse" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                      </svg>
                    </div>
                    <div>
                      <h4 class="font-semibold text-red-300">Portafolio Frágil</h4>
                      <p class="text-xs text-gray-400">Rendimiento degradado en el 20% de validación.</p>
                    </div>
                  }
                </div>
              </div>
            }
            <div class="border-t border-gray-700 pt-4">
              <h3 class="font-semibold mb-3">Métricas del Portafolio</h3>
              
              <!-- TABS -->
              <div class="flex border-b border-gray-600 text-sm mb-4">
                <button (click)="activeMetricsTab.set('equal')" 
                        class="px-4 py-2 transition-colors duration-200 -mb-px"
                        [class.text-white]="activeMetricsTab() === 'equal'"
                        [class.border-b-2]="activeMetricsTab() === 'equal'"
                        [class.border-cyan-400]="activeMetricsTab() === 'equal'"
                        [class.text-gray-400]="activeMetricsTab() !== 'equal'"
                        [class.hover:text-white]="activeMetricsTab() !== 'equal'">
                  Ponderación Equitativa
                </button>
                <button (click)="activeMetricsTab.set('montecarlo')" 
                        class="px-4 py-2 transition-colors duration-200 -mb-px"
                        [class.text-white]="activeMetricsTab() === 'montecarlo'"
                        [class.border-b-2]="activeMetricsTab() === 'montecarlo'"
                        [class.border-cyan-400]="activeMetricsTab() === 'montecarlo'"
                        [class.text-gray-400]="activeMetricsTab() !== 'montecarlo'"
                        [class.hover:text-white]="activeMetricsTab() !== 'montecarlo'">
                  Monte Carlo (P5)
                </button>
              </div>

              @if (activeMetricsTab() === 'equal') {
                <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                  <!-- Sharpe -->
                  <div class="flex justify-between cursor-pointer hover:bg-gray-700/50 -mx-1 px-1 rounded transition-colors" [class.bg-gray-700/50]="activePortfolioMetric() === 'sharpeRatio'" (click)="setActivePortfolioMetric('sharpeRatio')">
                    <div class="flex items-center space-x-2"><span>Sharpe:</span><svg (click)="showPopup('sharpeRatio'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <span class="font-mono" [class.text-cyan-300]="activePortfolioMetric() !== 'sharpeRatio'" [class.text-white]="activePortfolioMetric() === 'sharpeRatio'" [class.font-bold]="activePortfolioMetric() === 'sharpeRatio'">{{ portfolio()?.sharpeRatio.toFixed(2) }}</span>
                  </div>
                  <!-- Calmar -->
                  <div class="flex justify-between cursor-pointer hover:bg-gray-700/50 -mx-1 px-1 rounded transition-colors" [class.bg-gray-700/50]="activePortfolioMetric() === 'calmarRatio'" (click)="setActivePortfolioMetric('calmarRatio')">
                    <div class="flex items-center space-x-2"><span>Calmar:</span><svg (click)="showPopup('calmarRatio'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <span class="font-mono" [class.text-cyan-300]="activePortfolioMetric() !== 'calmarRatio'" [class.text-white]="activePortfolioMetric() === 'calmarRatio'" [class.font-bold]="activePortfolioMetric() === 'calmarRatio'">{{ portfolio()?.calmarRatio.toFixed(2) }}</span>
                  </div>
                  <!-- Treynor -->
                  <div class="flex justify-between cursor-pointer hover:bg-gray-700/50 -mx-1 px-1 rounded transition-colors" [class.bg-gray-700/50]="activePortfolioMetric() === 'treynorRatio'" (click)="setActivePortfolioMetric('treynorRatio')">
                    <div class="flex items-center space-x-2"><span>Treynor:</span><svg (click)="showPopup('treynorRatio'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <span class="font-mono" [class.text-cyan-300]="activePortfolioMetric() !== 'treynorRatio'" [class.text-white]="activePortfolioMetric() === 'treynorRatio'" [class.font-bold]="activePortfolioMetric() === 'treynorRatio'">{{ portfolio()?.treynorRatio.toFixed(2) }}</span>
                  </div>
                  <!-- Max DD -->
                  <div class="flex justify-between cursor-pointer hover:bg-gray-700/50 -mx-1 px-1 rounded transition-colors" [class.bg-gray-700/50]="activePortfolioMetric() === 'maxDrawdownPercent'" (click)="setActivePortfolioMetric('maxDrawdownPercent')">
                    <div class="flex items-center space-x-2"><span>Max DD:</span><svg (click)="showPopup('maxDrawdown'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <span class="font-mono" [class.text-cyan-300]="activePortfolioMetric() !== 'maxDrawdownPercent'" [class.text-white]="activePortfolioMetric() === 'maxDrawdownPercent'" [class.font-bold]="activePortfolioMetric() === 'maxDrawdownPercent'">{{ portfolio()?.maxDrawdownPercent.toFixed(2) }}%</span>
                  </div>
                  <!-- Recuperación -->
                  <div class="flex justify-between cursor-pointer hover:bg-gray-700/50 -mx-1 px-1 rounded transition-colors" [class.bg-gray-700/50]="activePortfolioMetric() === 'recoveryFactor'" (click)="setActivePortfolioMetric('recoveryFactor')">
                    <div class="flex items-center space-x-2"><span>Recuperación:</span><svg (click)="showPopup('recoveryFactor'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <span class="font-mono" [class.text-cyan-300]="activePortfolioMetric() !== 'recoveryFactor'" [class.text-white]="activePortfolioMetric() === 'recoveryFactor'" [class.font-bold]="activePortfolioMetric() === 'recoveryFactor'">{{ portfolio()?.recoveryFactor.toFixed(2) }}</span>
                  </div>
                  <!-- Moda Benef -->
                  <div class="flex justify-between cursor-pointer hover:bg-gray-700/50 -mx-1 px-1 rounded transition-colors" [class.bg-gray-700/50]="activePortfolioMetric() === 'profitMode'" (click)="setActivePortfolioMetric('profitMode')">
                    <div class="flex items-center space-x-2"><span>Moda Benef:</span><svg (click)="showPopup('profitMode'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <span class="font-mono" [class.text-cyan-300]="activePortfolioMetric() !== 'profitMode'" [class.text-white]="activePortfolioMetric() === 'profitMode'" [class.font-bold]="activePortfolioMetric() === 'profitMode'">{{ portfolio()?.profitMode.toFixed(2) }}</span>
                  </div>
                  <!-- P80 Benef -->
                  <div class="flex justify-between cursor-pointer hover:bg-gray-700/50 -mx-1 px-1 rounded transition-colors" [class.bg-gray-700/50]="activePortfolioMetric() === 'profitPercentile80'" (click)="setActivePortfolioMetric('profitPercentile80')">
                    <div class="flex items-center space-x-2"><span>P80 Benef:</span><svg (click)="showPopup('profitPercentile80'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <span class="font-mono" [class.text-cyan-300]="activePortfolioMetric() !== 'profitPercentile80'" [class.text-white]="activePortfolioMetric() === 'profitPercentile80'" [class.font-bold]="activePortfolioMetric() === 'profitPercentile80'">{{ portfolio()?.profitPercentile80.toFixed(2) }}</span>
                  </div>
                   <!-- Max Consecutive Losses -->
                  <div class="flex justify-between cursor-pointer hover:bg-gray-700/50 -mx-1 px-1 rounded transition-colors" [class.bg-gray-700/50]="activePortfolioMetric() === 'maxConsecutiveLosses'" (click)="setActivePortfolioMetric('maxConsecutiveLosses')">
                    <div class="flex items-center space-x-2"><span>Máx Pérdidas Consec:</span><svg (click)="showPopup('maxConsecutiveLosses'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <span class="font-mono" [class.text-cyan-300]="activePortfolioMetric() !== 'maxConsecutiveLosses'" [class.text-white]="activePortfolioMetric() === 'maxConsecutiveLosses'" [class.font-bold]="activePortfolioMetric() === 'maxConsecutiveLosses'">{{ portfolio()?.maxConsecutiveLosses.toFixed(0) }}</span>
                  </div>
                </div>
              } @else if (activeMetricsTab() === 'montecarlo') {
                @if (monteCarloResult(); as mc) {
                  <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                    <!-- Sharpe -->
                     <div class="flex justify-between -mx-1 px-1 rounded">
                      <div class="flex items-center space-x-2"><span>Sharpe:</span><svg (click)="showPopup('sharpeRatio'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                      <span class="font-mono text-cyan-300">{{ mc.p5.sharpeRatio.toFixed(2) }}</span>
                    </div>
                    <!-- Calmar -->
                    <div class="flex justify-between -mx-1 px-1 rounded">
                      <div class="flex items-center space-x-2"><span>Calmar:</span><svg (click)="showPopup('calmarRatio'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                      <span class="font-mono text-cyan-300">{{ mc.p5.calmarRatio.toFixed(2) }}</span>
                    </div>
                    <!-- Treynor -->
                    <div class="flex justify-between -mx-1 px-1 rounded">
                      <div class="flex items-center space-x-2"><span>Treynor:</span><svg (click)="showPopup('treynorRatio'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                      <span class="font-mono text-cyan-300">{{ mc.p5.treynorRatio.toFixed(2) }}</span>
                    </div>
                    <!-- Max DD -->
                    <div class="flex justify-between -mx-1 px-1 rounded">
                      <div class="flex items-center space-x-2"><span>Max DD:</span><svg (click)="showPopup('maxDrawdown'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                      <span class="font-mono text-cyan-300">{{ mc.p95.maxDrawdownPercent.toFixed(2) }}%</span>
                    </div>
                    <!-- Recuperación -->
                    <div class="flex justify-between -mx-1 px-1 rounded">
                      <div class="flex items-center space-x-2"><span>Recuperación:</span><svg (click)="showPopup('recoveryFactor'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                      <span class="font-mono text-cyan-300">{{ mc.p5.recoveryFactor.toFixed(2) }}</span>
                    </div>
                    <!-- R-Cuadrado -->
                    <div class="flex justify-between -mx-1 px-1 rounded">
                      <div class="flex items-center space-x-2"><span>R-Cuadrado:</span><svg (click)="showPopup('rSquared'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                      <span class="font-mono text-cyan-300">{{ mc.p5.rSquared.toFixed(2) }}</span>
                    </div>
                    <!-- Moda Benef -->
                    <div class="flex justify-between -mx-1 px-1 rounded">
                      <div class="flex items-center space-x-2"><span>Moda Benef:</span><svg (click)="showPopup('profitMode'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                      <span class="font-mono text-cyan-300">{{ mc.p5.profitMode.toFixed(2) }}</span>
                    </div>
                    <!-- P80 Benef -->
                     <div class="flex justify-between -mx-1 px-1 rounded">
                      <div class="flex items-center space-x-2"><span>P80 Benef:</span><svg (click)="showPopup('profitPercentile80'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                      <span class="font-mono text-cyan-300">{{ mc.p5.profitPercentile80.toFixed(2) }}</span>
                    </div>
                    <!-- Max Consecutive Losses -->
                    <div class="flex justify-between -mx-1 px-1 rounded">
                      <div class="flex items-center space-x-2"><span>Máx Pérdidas Consec:</span><svg (click)="showPopup('maxConsecutiveLosses'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                      <span class="font-mono text-cyan-300">{{ mc.p95.maxConsecutiveLosses.toFixed(0) }}</span>
                    </div>
                     <div class="col-span-2 text-xs text-gray-500 pt-2">Resultados con 95% de confianza (P5 para ganancias, P95 para pérdidas).</div>
                  </div>
                } @else {
                  <div class="text-center text-gray-500 py-4 text-sm">
                    Calculando simulación...
                  </div>
                }
              }
            </div>
            
            @if (activeMetricsTab() === 'equal') {
              <ul class="max-h-40 overflow-y-auto space-y-2 pr-2 mt-4">
                @for(strat of selectedStrategies(); track strat.id) {
                  <li class="flex items-center justify-between bg-gray-700/50 p-2 rounded-md">
                    <span class="text-sm text-gray-300">ID: {{ strat.id }}</span>
                    
                    @if (strategyImpactValues().has(strat.id) && activePortfolioMetric(); as metric) {
                      @let baselineValue = portfolio()?.[metric] ?? 0;
                      @let valueWithout = strategyImpactValues().get(strat.id)!;
                      @let isPositive = positiveMetrics.includes(metric);
                      @let improves = (isPositive && valueWithout > baselineValue) || (!isPositive && valueWithout < baselineValue);
                      @let formattedValue = metric === 'maxConsecutiveLosses' ? valueWithout.toFixed(0) : valueWithout.toFixed(2);

                      <div class="flex items-center space-x-2 text-xs font-mono">
                        <span class="text-gray-400" [title]="'Métrica si se elimina esta estrategia'">
                          (sin esta: {{ formattedValue }}{{ metric === 'maxDrawdownPercent' ? '%' : ''}})
                        </span>
                        
                        @if (Math.abs(valueWithout - baselineValue) > 1e-9) {
                          @if (improves) {
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3" [title]="'Al eliminar, la métrica mejora a ' + formattedValue">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
                            </svg>
                          } @else {
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3" [title]="'Al eliminar, la métrica empeora a ' + formattedValue">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                          }
                        }
                      </div>
                    }

                    <button (click)="toggleSelection(strat, $event)" class="text-red-400 hover:text-red-300 ml-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                  </li>
                }
              </ul>
            }
          </div>
        }
      </div>

       <!-- Correlation Matrix Card -->
      <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700/50">
        <h3 class="font-semibold text-gray-100 mb-4">Matriz de Correlación</h3>
        @if (correlationMatrix(); as data) {
            <div #correlationHeatmap class="w-full h-64"></div>
        } @else {
            <div class="text-center text-gray-500 py-8">
                <p>Seleccione 2 o más estrategias para ver su correlación.</p>
            </div>
        }
      </div>

      <!-- Filter Card -->
      <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700/50">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-100">Filtros</h2>
          <button (click)="reiniciarFiltros()" class="text-sm text-cyan-400 hover:text-cyan-300 transition-colors">Reiniciar</button>
        </div>
        <div class="space-y-3">
            
            <!-- Min Win Rate -->
            <div class="flex items-center justify-between bg-gray-900/70 rounded-lg p-2.5">
                <label for="minWinRate" class="text-sm font-medium text-gray-400">Min Win Rate</label>
                <div class="flex items-center space-x-2">
                    <input id="minWinRate" type="number" step="0.01" max="1" min="0" 
                           [value]="filters().minWinRate" 
                           (input)="updateFilter('minWinRate', $event)" 
                           class="w-20 bg-transparent text-right text-cyan-400 font-mono text-sm focus:outline-none">
                    <button (click)="saveFilterAsDefault('minWinRate')" title="Guardar como valor por defecto" class="text-gray-500 hover:text-cyan-400 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3l-4 4-4-4zM15 3h-6a2 2 0 00-2 2v5a2 2 0 002 2h6a2 2 0 002-2V5a2 2 0 00-2-2z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Min Expectancy -->
            <div class="flex items-center justify-between bg-gray-900/70 rounded-lg p-2.5">
                <div class="flex items-center space-x-2">
                  <label for="minExpectancy" class="text-sm font-medium text-gray-400">Expectativa</label>
                  <svg (click)="showPopup('expectancy'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div class="flex items-center space-x-2">
                    <input id="minExpectancy" type="number" step="0.1" 
                           [value]="filters().minExpectancy" 
                           (input)="updateFilter('minExpectancy', $event)" 
                           class="w-20 bg-transparent text-right text-cyan-400 font-mono text-sm focus:outline-none">
                     <button (click)="saveFilterAsDefault('minExpectancy')" title="Guardar como valor por defecto" class="text-gray-500 hover:text-cyan-400 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3l-4 4-4-4zM15 3h-6a2 2 0 00-2 2v5a2 2 0 002 2h6a2 2 0 002-2V5a2 2 0 00-2-2z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Min Profit Mode -->
            <div class="flex items-center justify-between bg-gray-900/70 rounded-lg p-2.5">
                <div class="flex items-center space-x-2">
                  <label for="minProfitMode" class="text-sm font-medium text-gray-400">Min Moda Benef.</label>
                  <svg (click)="showPopup('profitMode'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div class="flex items-center space-x-2">
                    <input id="minProfitMode" type="number" step="1" 
                           [value]="filters().minProfitMode" 
                           (input)="updateFilter('minProfitMode', $event)" 
                           class="w-20 bg-transparent text-right text-cyan-400 font-mono text-sm focus:outline-none">
                     <button (click)="saveFilterAsDefault('minProfitMode')" title="Guardar como valor por defecto" class="text-gray-500 hover:text-cyan-400 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3l-4 4-4-4zM15 3h-6a2 2 0 00-2 2v5a2 2 0 002 2h6a2 2 0 002-2V5a2 2 0 00-2-2z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Min P80 Benefit -->
            <div class="flex items-center justify-between bg-gray-900/70 rounded-lg p-2.5">
                <div class="flex items-center space-x-2">
                  <label for="minProfitPercentile80" class="text-sm font-medium text-gray-400">Min P80 Benef.</label>
                  <svg (click)="showPopup('profitPercentile80'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div class="flex items-center space-x-2">
                    <input id="minProfitPercentile80" type="number" step="1" 
                           [value]="filters().minProfitPercentile80" 
                           (input)="updateFilter('minProfitPercentile80', $event)" 
                           class="w-20 bg-transparent text-right text-cyan-400 font-mono text-sm focus:outline-none">
                     <button (click)="saveFilterAsDefault('minProfitPercentile80')" title="Guardar como valor por defecto" class="text-gray-500 hover:text-cyan-400 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3l-4 4-4-4zM15 3h-6a2 2 0 00-2 2v5a2 2 0 002 2h6a2 2 0 002-2V5a2 2 0 00-2-2z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Max Avg Trade Duration -->
            <div class="flex items-center justify-between bg-gray-900/70 rounded-lg p-2.5">
                <div class="flex items-center space-x-2">
                  <label for="maxAvgTradeDuration" class="text-sm font-medium text-gray-400">Max Duración Trade</label>
                  <svg (click)="showPopup('avgTradeDuration'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div class="flex items-center space-x-2">
                    <input id="maxAvgTradeDuration" type="number" 
                           [value]="filters().maxAvgTradeDuration" 
                           (input)="updateFilter('maxAvgTradeDuration', $event)" 
                           class="w-20 bg-transparent text-right text-cyan-400 font-mono text-sm focus:outline-none">
                     <button (click)="saveFilterAsDefault('maxAvgTradeDuration')" title="Guardar como valor por defecto" class="text-gray-500 hover:text-cyan-400 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3l-4 4-4-4zM15 3h-6a2 2 0 00-2 2v5a2 2 0 002 2h6a2 2 0 002-2V5a2 2 0 00-2-2z" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Min Z-Score -->
            <div class="flex items-center justify-between bg-gray-900/70 rounded-lg p-2.5">
                <div class="flex items-center space-x-2">
                  <label for="minZScore" class="text-sm font-medium text-gray-400">Min Z-Score</label>
                  <svg (click)="showPopup('zScore'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div class="flex items-center space-x-2">
                    <input id="minZScore" type="number" step="0.1" 
                           [value]="filters().minZScore" 
                           (input)="updateFilter('minZScore', $event)" 
                           class="w-20 bg-transparent text-right text-cyan-400 font-mono text-sm focus:outline-none">
                     <button (click)="saveFilterAsDefault('minZScore')" title="Guardar como valor por defecto" class="text-gray-500 hover:text-cyan-400 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3l-4 4-4-4zM15 3h-6a2 2 0 00-2 2v5a2 2 0 002 2h6a2 2 0 002-2V5a2 2 0 00-2-2z" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Max Rango IC -->
            <div class="flex items-center justify-between bg-gray-900/70 rounded-lg p-2.5">
                <div class="flex items-center space-x-2">
                  <label for="maxIqr" class="text-sm font-medium text-gray-400">Max Rango IC</label>
                  <svg (click)="showPopup('iqr'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                 <div class="flex items-center space-x-2">
                    <input id="maxIqr" type="number" step="1" 
                           [value]="filters().maxIqr" 
                           (input)="updateFilter('maxIqr', $event)" 
                           class="w-20 bg-transparent text-right text-cyan-400 font-mono text-sm focus:outline-none">
                     <button (click)="saveFilterAsDefault('maxIqr')" title="Guardar como valor por defecto" class="text-gray-500 hover:text-cyan-400 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3l-4 4-4-4zM15 3h-6a2 2 0 00-2 2v5a2 2 0 002 2h6a2 2 0 002-2V5a2 2 0 00-2-2z" />
                        </svg>
                    </button>
                </div>
            </div>
             <!-- Min R-Squared -->
            <div class="flex items-center justify-between bg-gray-900/70 rounded-lg p-2.5">
                <div class="flex items-center space-x-2">
                  <label for="minRSquared" class="text-sm font-medium text-gray-400">Min R-Cuadrado</label>
                  <svg (click)="showPopup('rSquared'); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-cyan-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div class="flex items-center space-x-2">
                    <input id="minRSquared" type="number" step="1" 
                           [value]="filters().minRSquared" 
                           (input)="updateFilter('minRSquared', $event)" 
                           class="w-20 bg-transparent text-right text-cyan-400 font-mono text-sm focus:outline-none">
                     <button (click)="saveFilterAsDefault('minRSquared')" title="Guardar como valor por defecto" class="text-gray-500 hover:text-cyan-400 transition-colors cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3l-4 4-4-4zM15 3h-6a2 2 0 00-2 2v5a2 2 0 002 2h6a2 2 0 002-2V5a2 2 0 00-2-2z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
      </div>
    </aside>

    <!-- Main Content: Table -->
    <section class="w-full flex-grow flex flex-col">
      <!-- Action Buttons -->
      <div class="mb-6 space-y-3 sm:space-y-0 sm:flex sm:items-center sm:justify-between">
        <div class="flex items-center space-x-4">
            <button (click)="runMassiveMonkeyTest()" 
                    [disabled]="rawStrategies().length === 0 || isTesting()" 
                    class="w-full sm:w-auto px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors disabled:bg-indigo-800 disabled:cursor-wait flex items-center justify-center space-x-2"
                    title="Ejecuta 2500 permutaciones aleatorias en los trades de cada estrategia para verificar que su rendimiento (Calmar Ratio) supera el 95% de los resultados generados por azar.">
              @if (isTesting()) {
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Probando...</span>
              } @else {
                <span>Ejecutar Monkey Test Masivo</span>
              }
            </button>
             <button (click)="clearAllStrategies()"
                  [disabled]="rawStrategies().length === 0"
                  class="w-full sm:w-auto px-5 py-2.5 bg-red-700 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors disabled:bg-red-800 disabled:text-gray-400 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              <span>Eliminar Todo</span>
            </button>
        </div>
        <h2 class="text-lg font-semibold text-gray-100 text-right">Estrategias ({{ selectedStrategies().length }} / {{ sortedStrategies().length }} / {{ rawStrategies().length }})</h2>
      </div>

      <!-- Strategy Table Card -->
      <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700/50 overflow-hidden flex-grow flex flex-col">
        <div class="overflow-x-auto flex-grow">
          <div class="align-middle inline-block min-w-full">
            <div class="shadow overflow-hidden">
              <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-800 sticky top-0">
                  <tr>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-12">
                      <input type="checkbox"
                             [checked]="areAllFilteredSelected()"
                             (change)="toggleSelectAll()"
                             [disabled]="sortedStrategies().length === 0"
                             title="Seleccionar todo"
                             class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-cyan-500 focus:ring-cyan-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    </th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('id')">ID</th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('robustnessScore')">Robustez</th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('mitigationScore')">Mitigación</th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('profit')">Beneficio</th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('expectancy')">Expectativa</th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('profitMode')">Moda Benef.</th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('winRate')">Win Rate</th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('profitPercentile80')">P80 Benef.</th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('zScore')">Z-Score</th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('iqr')">Rango IC</th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('rSquared')">R-Cuadrado</th>
                    <th scope="col" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider cursor-pointer" (click)="setSort('avgTradeDuration')">Duración</th>
                  </tr>
                </thead>
                <tbody class="bg-gray-800/50 divide-y divide-gray-700/50">
                   @if (sortedStrategies().length === 0) {
                    <tr>
                      <td colspan="13" class="text-center text-gray-500 py-16">
                        @if (rawStrategies().length === 0) {
                          <span class="block">Cargue un archivo JSON para comenzar.</span>
                        } @else {
                          <span class="block">No hay estrategias que cumplan con los filtros.</span>
                        }
                      </td>
                    </tr>
                  } @else {
                    @for(strat of sortedStrategies(); track strat.id) {
                      <tr (click)="showStrategyDetails(strat)" class="hover:bg-gray-700/40 transition-colors cursor-pointer" [class.bg-cyan-900/20]="isSelected(strat.id)">
                        <td class="p-3 whitespace-nowrap" (click)="$event.stopPropagation()">
                          <input type="checkbox" [checked]="isSelected(strat.id)" (change)="toggleSelection(strat, $event)" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-cyan-500 focus:ring-cyan-600">
                        </td>
                        <td class="p-3 whitespace-nowrap text-sm text-gray-300">{{ strat.id }}</td>
                        <td class="p-3 whitespace-nowrap text-sm font-mono" [class.text-green-400]="strat.robustnessScore > 75" [class.text-yellow-400]="strat.robustnessScore >= 50 && strat.robustnessScore <= 75" [class.text-red-400]="strat.robustnessScore < 50">{{ strat.robustnessScore.toFixed(1) }}</td>
                        <td class="p-3 whitespace-nowrap text-sm font-mono" 
                            [class.text-green-400]="strat.mitigationScore && strat.mitigationScore > 75" 
                            [class.text-yellow-400]="strat.mitigationScore && strat.mitigationScore >= 50 && strat.mitigationScore <= 75" 
                            [class.text-red-400]="strat.mitigationScore && strat.mitigationScore < 50">
                            {{ strat.mitigationScore?.toFixed(1) }}
                        </td>
                        <td class="p-3 whitespace-nowrap text-sm font-mono" [class.text-green-400]="strat.backtestStats.profit > 0" [class.text-red-400]="strat.backtestStats.profit < 0">{{ strat.backtestStats.profit.toFixed(2) }}</td>
                        <td class="p-3 whitespace-nowrap text-sm font-mono" [class.text-green-400]="strat.expectancy > 0" [class.text-red-400]="strat.expectancy < 0">{{ strat.expectancy.toFixed(2) }}</td>
                        <td class="p-3 whitespace-nowrap text-sm font-mono" [class.text-green-400]="strat.profitMode > 0" [class.text-red-400]="strat.profitMode < 0">{{ strat.profitMode.toFixed(2) }}</td>
                        <td class="p-3 whitespace-nowrap text-sm font-mono">{{ (strat.winRate * 100).toFixed(1) }}%</td>
                        <td class="p-3 whitespace-nowrap text-sm font-mono">{{ strat.profitPercentile80.toFixed(2) }}</td>
                        <td class="p-3 whitespace-nowrap text-sm font-mono">{{ strat.zScore.toFixed(2) }}</td>
                        <td class="p-3 whitespace-nowrap text-sm font-mono">{{ strat.iqr.toFixed(2) }}</td>
                        <td class="p-3 whitespace-nowrap text-sm font-mono">{{ strat.backtestStats.rSquared.toFixed(2) }}</td>
                        <td class="p-3 whitespace-nowrap text-sm font-mono">{{ strat.avgTradeDuration.toFixed(0) }}</td>
                      </tr>
                    }
                  }
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Results Summary -->
        @if (sortedStrategies().length > 0) {
          <div class="p-4 border-t border-gray-700/50 text-sm">
            <p class="text-gray-400">
              Mostrando <span class="font-medium">1</span> a <span class="font-medium">{{ sortedStrategies().length }}</span> de <span class="font-medium">{{ sortedStrategies().length }}</span> resultados
            </p>
          </div>
        }
      </div>
    </section>
  </div>

  <!-- Info Popup Modal -->
  @if (popupContent(); as content) {
    <div class="fixed inset-0 bg-black/60 z-40 flex items-center justify-center p-4" (click)="hidePopup()">
      <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl max-w-lg w-full p-6" (click)="$event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-cyan-400">{{ content.title }}</h3>
          <button (click)="hidePopup()" class="text-gray-400 hover:text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <p class="text-gray-300 leading-relaxed">{{ content.description }}</p>
      </div>
    </div>
  }

  <!-- Export Modal -->
  @if (exportableFiles(); as files) {
    <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" (click)="closeExportModal()">
      <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl max-w-lg w-full p-6" (click)="$event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-cyan-400">Exportar Archivos de Portafolio</h3>
          <button (click)="closeExportModal()" class="text-gray-400 hover:text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <p class="text-gray-400 mb-4 text-sm">El portafolio contiene estrategias de los siguientes archivos originales. Haga clic para descargar cada archivo filtrado.</p>
        <ul class="space-y-2 max-h-80 overflow-y-auto pr-2">
          @for(file of files; track file.fileName) {
            <li class="flex items-center justify-between bg-gray-700/50 p-3 rounded-md">
              <span class="text-sm font-mono text-gray-300">{{ file.fileName }}</span>
              <button (click)="downloadFile(file.fileName, file.content)" class="px-3 py-1 bg-teal-600 text-white text-xs font-semibold rounded-md hover:bg-teal-700 transition-colors flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                <span>Descargar</span>
              </button>
            </li>
          }
        </ul>
      </div>
    </div>
  }

  <!-- Strategy Details Modal -->
  @if (detailedStrategy(); as strat) {
    <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="hideStrategyDetails()">
      <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl max-w-4xl w-full p-6" (click)="$event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-cyan-400">Detalles de Estrategia: ID {{ strat.id }}</h3>
          <button (click)="hideStrategyDetails()" class="text-gray-400 hover:text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[400px]">
          <div>
            <h4 class="font-semibold text-gray-300 mb-2 text-center">Curva de Equidad</h4>
            <div #strategyEquityChart class="w-full h-[350px]"></div>
          </div>
          <div>
            <h4 class="font-semibold text-gray-300 mb-2 text-center">Drawdown (%)</h4>
            <div #strategyDrawdownChart class="w-full h-[350px]"></div>
          </div>
        </div>
      </div>
    </div>
  }
</main>
